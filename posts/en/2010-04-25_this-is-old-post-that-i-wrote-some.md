---
layout: post
title: "HFS+ and Unicode madness"
date: 2010-04-25
comments: false
---

<p><strong>This is an old post that I wrote some while ago, but never published it. It is here just for historical|nostalgic|unburdening reasons. Original post begins here:</strong></p>

Annoying scenario: A file with unicode characters in its filename, like `Pétalo.java`:

<script src="http://gist.github.com/489706.js?file=gistfile1.txt"></script>

<p>Why? That’s easy, because Mac OS X java wants everything with MacRoman encoding (<span class='caps'>WTF</span>??). Then I tried with the -encoding flag and tab-autocompletion for the filename:</p><br />
<script src="http://gist.github.com/489709.js?file=gistfile1.txt"></script><br />
<br />
<p>That is not good. When using autocompletion the filename is represented in <span class='caps'>NFD</span> or Normalization Form Canonical Decomposition (é =&gt; 65 cc81) but the class name in the file uses <span class='caps'>NFC</span> or Normalization Form Canonical Composition (é =&gt; c3a9). What a mess! Do you see the difference?:</p><script src="http://gist.github.com/489712.js?file=gistfile1.txt"></script><br />
<p>You can’t see the difference until you see the actual bytes of the string, and that’s why Apple tries to protect us by storing everything in the Filesystem with the same representation: <span class='caps'>NFD</span>. The first echo was done with autocompletion while the latter was typed directly with the keyboard. So if I compile the java sourcecode by fully typing the filename, it succeeds.</p><h3>¿What about version control?</h3><p>Then, this leads to a major problem. When someone in the world (including you and me) creates a file, he types its name with the keyboard, which as I have showed, it gives <span class='caps'>NFC</span> in Mac OS X. But with <span class='caps'>HFS</span>, the file is stored using <span class='caps'>NFD</span> and if you clone a git repo created in another OS you’ll see that you have untracked files without modifying anything!!</p><h3><span class='caps'>UFS</span> to the rescue (kind of…)</h3><p>Maybe you could say “well, just use another filesystem”, and I’ve done that, but it seems that Apple uses it’s decomposition algorithms everywhere.</p><p>First I tried <span class='caps'>ZFS</span> as I thought “That FS should work correctly in <span class='caps'>OSX</span>, they can’t spoil it”. But I installed the read-write implementation from MacOS Forge and it did the same stupid conversion (<span class='caps'>UPDATE</span>: <span class='caps'>ZFS</span> is discontinued in MacOS Forge :( ).</p><p><span class='caps'>FAT</span> is a no-no since it only accepts <span class='caps'>ASCII</span> characters for the filename and I don’t want to start a remote server nor a Virtual Machine every time I have to work with those files. This should work with my beloved OS!! And in fact, I have successfully made everything I’ve needed to work in Mac OS, until now :(.</p><p>So I needed to try <span class='caps'>UFS</span>, I looked at DiskUtility, but it doesn’t support <span class='caps'>UFS</span> and newfs fails to format my external <span class='caps'>USB</span> disk.</p><p>But since I used hdiutil to create Pallet’s dmg, I thought of havin a <span class='caps'>UFS</span> diskimage and guess what, you can!! This is the magic command:</p><script src="http://gist.github.com/489715.js?file=gistfile1.txt"></script><br />
<p>Now I can mount my dmg, compile and use git!!</p><p>But still there are two little problems:</p><ul><li>Snow Leopard doesn’t support <span class='caps'>UFS</span>. I can’t even mount my <span class='caps'>UFS</span> disk image :(</li>
<li>Every app that uses Cocoa to open files can’t read files with <span class='caps'>NFC</span> filenames. This means “forget about TextMate”. Noooooooo!!</li>
</ul><h3>Update</h3><p>Now I’ve updated to Snow Leopard and is very disappointing and sad that I have to use a virtual machine to do my job.</p><p>The good thing is that I can work with TextMate via ssh and MacFusion.</p><p>Bad things: MacOS X can solve my problem, I can’t open files with <span class='caps'>NFC</span> names in TextMate (but emacs.app still loves me) and although it seems there are some people working with File Systems at Apple I think this won’t be solved anytime soon.</p>
